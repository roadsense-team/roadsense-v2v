/**
 * @file main_gps_driver_test.cpp.bak
 * @brief NEO6M GPS Driver Test Firmware
 *
 * Tests NEO6M_Driver implementation:
 * - Non-blocking operation
 * - Cache state logic (fresh/cached/stale/none)
 * - Heading validation (speed-dependent)
 * - Quality indicators (satellites, HDOP)
 *
 * Expected behavior:
 * - Indoor: "No GPS data available" (no fix expected)
 * - Outdoor: First fix in 30-60s (cold start)
 * - Moving >5 km/h: Heading valid ✅
 * - Stationary/slow: Heading invalid ❌
 *
 * To activate:
 * 1. Rename to main.cpp (backup current main.cpp first)
 * 2. Build and flash
 * 3. Monitor serial @ 115200 baud
 */

#include <Arduino.h>
#include "sensors/gps/NEO6M_Driver.h"
#include "utils/Logger.h"

NEO6M_Driver gpsDriver;
uint32_t lastPrint = 0;

#ifndef UNIT_TEST
void setup() {
    Logger& log = Logger::getInstance();
    log.begin(115200);
    log.setLogLevel(LOG_DEBUG);

    log.info("MAIN", "═══════════════════════════════════");
    log.info("MAIN", "   NEO6M GPS Driver Test");
    log.info("MAIN", "═══════════════════════════════════");

    if (!gpsDriver.begin()) {
        log.error("MAIN", "❌ GPS initialization failed!");
        while (1) { delay(1000); }
    }

    log.info("MAIN", "✅ GPS initialized. Waiting for fix...");
    log.info("MAIN", "Expected: 30-60s (cold start)");
}

void loop() {
    // ✅ CRITICAL: Call update() every iteration (~100Hz)
    gpsDriver.update();

    // Print status every 2 seconds
    if (millis() - lastPrint > 2000) {
        Logger& log = Logger::getInstance();
        IGpsSensor::GpsData data = gpsDriver.read();

        log.info("GPS", "═══════════════════════════════════");
        log.info("GPS", "Ever had fix: " + String(gpsDriver.hasEverHadFix() ? "YES ✅" : "NO ❌"));
        log.info("GPS", "Valid: " + String(data.valid ? "YES ✅" : "NO ❌"));
        log.info("GPS", "Cached: " + String(data.cached ? "YES" : "NO"));
        log.info("GPS", "Age: " + String(data.age()) + " ms");

        if (data.valid || data.cached) {
            char buf[128];
            sprintf(buf, "Position: %.6f, %.6f", data.latitude, data.longitude);
            log.info("GPS", buf);
            sprintf(buf, "Altitude: %.2f m", data.altitude);
            log.info("GPS", buf);
            sprintf(buf, "Speed: %.2f m/s (%.1f km/h)", data.speed, data.speed * 3.6);
            log.info("GPS", buf);

            // ✅ Heading validity indicator
            const char* headingStatus = (data.speed >= GPS_HEADING_MIN_SPEED_MPS) ? "✅ VALID" : "❌ TOO SLOW";
            sprintf(buf, "Heading: %.1f° %s", data.heading, headingStatus);
            log.info("GPS", buf);

            sprintf(buf, "Quality: %d sats, HDOP=%.1f", data.satellites, data.hdop);
            log.info("GPS", buf);
        } else {
            log.warning("GPS", "⚠️  No GPS data available");
        }

        lastPrint = millis();
    }
}
#endif
