/***************************************************************************
 * I2C Scanner - Debugging Tool
 *
 * Purpose: Scan I2C bus and report all detected devices
 *
 * This will help us find the actual I2C address of the MPU9250
 * Expected addresses:
 * - 0x68: MPU9250 (ADO pin LOW or not connected)
 * - 0x69: MPU9250 (ADO pin HIGH)
 *
 ***************************************************************************/

#include <Arduino.h>
#include <Wire.h>

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("\n\n========================================");
  Serial.println("I2C Bus Scanner");
  Serial.println("========================================\n");

  Wire.begin(21, 22);  // SDA=21, SCL=22
  Serial.println("I2C bus initialized (SDA=21, SCL=22)\n");
  Serial.println("Scanning I2C bus (addresses 0x01 to 0x7F)...\n");

  byte error, address;
  int devicesFound = 0;

  for(address = 1; address < 127; address++ ) {
    Wire.beginTransmission(address);
    error = Wire.endTransmission();

    if (error == 0) {
      Serial.print("✅ Device found at address 0x");
      if (address < 16) Serial.print("0");
      Serial.print(address, HEX);
      Serial.print(" (");
      Serial.print(address);
      Serial.print(")");

      // Identify known devices
      if (address == 0x68) Serial.print(" - Likely MPU9250/MPU6050");
      if (address == 0x69) Serial.print(" - Likely MPU9250/MPU6050 (ADO=HIGH)");
      if (address == 0x0C) Serial.print(" - Likely AK8963 Magnetometer");

      Serial.println();
      devicesFound++;
    }
    else if (error == 4) {
      Serial.print("⚠️  Unknown error at address 0x");
      if (address < 16) Serial.print("0");
      Serial.println(address, HEX);
    }
  }

  Serial.println("\n========================================");
  if (devicesFound == 0) {
    Serial.println("❌ NO I2C DEVICES FOUND!");
    Serial.println("\nPossible causes:");
    Serial.println("1. Wiring issue:");
    Serial.println("   - Check SDA (GPIO 21) connection");
    Serial.println("   - Check SCL (GPIO 22) connection");
    Serial.println("   - Verify both wires are firmly connected");
    Serial.println("2. Power issue:");
    Serial.println("   - Check VCC is connected to 3.3V");
    Serial.println("   - Check GND is connected");
    Serial.println("   - Is there a power LED on the sensor?");
    Serial.println("3. Faulty sensor or loose connections");
  }
  else {
    Serial.print("✅ Found ");
    Serial.print(devicesFound);
    Serial.println(" device(s)");

    Serial.println("\nNext steps:");
    Serial.println("- Use the detected address in your code");
    Serial.println("- If 0x68 or 0x69 found, MPU9250 is working!");
  }
  Serial.println("========================================\n");
}

void loop() {
  // Rescan every 5 seconds
  delay(5000);
  Serial.println("\n--- Rescanning I2C bus ---");
  setup();
}
